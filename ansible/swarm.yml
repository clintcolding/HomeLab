- hosts: rpi
  remote_user: pi
  become: yes
  
  vars_files:
    - ./vault.yml

  vars:
    ansible_ssh_pass: "{{ remote_pass }}"
    
  tasks:
  - name: create leader
    docker_swarm:
      state: present
    when: role is defined and role == "leader"

  - name: get join token
    shell: docker swarm join-token -q worker
    register: token
    when: role is defined and role == "leader"

  - name: add workers
    docker_swarm:
      state: join
      advertise_addr: 192.168.1.133
      join_token: "{{ hostvars['rpi01']['token']['stdout'] }}"
      remote_addrs: [ '192.168.1.132:2377' ]
    when: role is undefined